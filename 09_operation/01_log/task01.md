# 課題01

## 質問

### ログレベル

ログメッセージの重要度を表す指標である。  

#### どのようなレベル

- Trace  
  アプリケーションやライブラリの内部の動作を追跡するための情報を出力するレベル。  
- Debug  
  問題の調査やトラブルシューティングを行うための情報を出力するレベル。  
  テスト環境でアプリケーションの動作を確認する際にも利用される。  
- Info  
  標準のログレベル。アプリケーションの正常な動作に関する情報を出力するレベル。  
  ユーザーの操作やアプリケーションの状態変化などを出力する。  
- Warn  
  予期しない問題が発生したが、アプリケーションの動作に影響がない場合に出力するレベル。  
  例えば、ディスク容量が不足しているが、アプリケーションは動作している場合など。
- Error  
  エラーが発生した場合に出力するレベル。  
  例えば、データベースへの接続に失敗した場合など。
- Fatal  
  アプリケーションが停止するような致命的なエラーが発生した場合に出力するレベル。  
  例えば、データベースの接続情報が間違っている場合など。

#### ログレベルを指定するメリット

- ログの出力量を制御できる
- 特定のログレベルのログを抽出できる

### アプリケーションログに含める情報

- タイムスタンプ
- ホスト名
- スレッド名
- ログレベル
- アプリケーションのアクション
  ユーザーのログイン、注文の作成、商品の検索など
- 関連するコンテキスト情報  
  例えば、ユーザーID、セッションID、リクエストIDなど
- エラーメッセージ

#### 含めない情報

- 個人情報
- 機密情報
- 冗長な内容

### タイミング

- Trace
  - 関数の開始
  - 関数の終了
  - ループの開始
  - ループの終了
- Debug
  - 外部ライブラリ, 外部システムの呼び出し
  - 処理途中の状態変化
- Info
  - 処理の開始
  - 処理が終了
  - ユーザー操作
- Warn
  - 非推奨機能の利用
  - パフォーマンスの低下
  - 将来的に発生する問題を検知
- Error
  - 例外の発生
  - データ不整合
  - 予期/意図しない問題の発生
  - 外部システムのエラー
- Fatal
  - 致命的なエラーが発生
  - システムの停止
  - 重大なデータの損失
  - ディスクの枯渇
  - 重大なセキュリティ問題

### パースしやすくなるには

構造化されたログを出力することで、ログをパースしやすくすることができる。  
JSON形式、logfmt形式

JSON形式

```json
{
  "timestamp": "2020-11-07T15:57:35.945508391Z",
  "severity": "ERROR",
  "message": "There was an error in the application",
  "httpRequest": {
    "requestMethod": "GET",
    "requestUrl": "/some-path",
    "status": 200,
    "userAgent": "Opera/12.0",
    "remoteIp": "127.0.0.1"
  },
  "logName": "projects/stackdriver-sandbox-92334288/logs/stdout",
  "sourceLocation": {
    "file": "get_data.py",
    "line": 142,
    "function": "getData"
  }
}
```

logfmt形式: key=valueでログを出力する

```sh
timestamp=2020-11-07T15:57:35.945508391Z severity=ERROR message="There was an error in the application" requestMethod=GET requestUrl=/some-path status=200 userAgent="Opera/12.0" remoteIp=127.0.0.1 file=get_data.py line=142 function=getData
```

### ログの種類

#### アクセスログ

ウェブサーバーやアプリケーションサーバーなどに対するアクセスの記録を保持するログ。  
クライアントのIPアドレス、リクエストの種類（GET、POSTなど）、
リクエストされたリソースのパス、リクエストの日時などの情報を記録する。  

#### アプリケーションログ

アプリケーションの動作に関する情報を記録するログ。  
アプリケーションの起動、終了、エラーの発生、ユーザーの操作などの情報を記録する。  

#### エラーログ

アプリケーションやシステム内で発生したエラーや警告に関する情報を記録するログ。  
エラーの発生時刻、エラーの原因、エラーの内容などの情報を記録する。  

#### （フロントエンドの）ユーザーログ

ウェブサイトやウェブアプリケーションのフロントエンドでユーザーのアクションや挙動に関する情報を記録するログ。  
ユーザーの操作、ユーザーのアクティビティ、ページの遷移、エラーの発生などの情報を記録する。  

#### データベースのクエリログ

データベースに対するクエリの実行に関する情報を記録するログ。  
クエリの実行時刻、クエリの内容、クエリの実行結果などの情報を記録する。  

### ログローテーション

ログファイルのサイズが一定のサイズに達した場合、  
古いログファイルを削除することで、ログファイルのサイズを一定のサイズに保つ仕組み。  

#### ログローテーションのメリット

- ディスク容量の節約
- ログファイルの管理が容易
- 機密情報の保護

#### ログローテーションのデメリット

- ログファイルの削除による情報の損失
- ログローテーションの設定が負担になる  
  ローテーションのスケジュールや方法を定期的に見直す必要がある。  

#### 利用が減った背景

- クラウドロギングサービスの普及  
  ログの収集、保存、分析を自動化し、ログローテーションの必要性を低減させた。  
- ストレージのコスト低下
- セキュリティとコンプライアンス要件の増加  
  セキュリティとコンプライアンス要件に適合するために、  
  企業はより長期間にわたってログデータを保持する必要が生じた。
- データ分析とトラブルシューティングの需要の増加  
  ビッグデータ分析や機械学習を活用したログ分析が一般的になり、  
  古いログデータを保持し、将来の分析やトラブルシューティングに活用するニーズが増加した。  

### インスタンスにログファイルを保存を避ける

- 複数インスタンスからログを収集する必要がある
- インスタンスが停止した場合、ログファイルが消失する可能性がある  
- 不正アクセスやセキュリティインシデントの際に、攻撃者にログファイルを改ざん、削除される可能性がある
- インスタンスのディスク容量が不足する可能性がある
- ログを収集し一元管理することで、ログの検索、分析、可視化が容易になる  
- アクセス制御ができる

#### ログファイルの閲覧権限を細かく管理

権限管理でログファイルを閲覧できるユーザーを制限する。  
データ保護機能を利用して、個人情報や機密情報をマスクする。  

#### 特定のログを誰が閲覧したか、または誰が編集したか

ログファイルのアクセスログを記録し、  
ログファイルを閲覧したユーザー、編集したユーザーを記録する。

#### 複数のインスタンスからログを収集

- クラウドサービスにログを送信する  
- 共有ストレージにログを保存する

#### ログファイルがシステムのストレージ容量を食い尽くす

- クラウドサービスにログを送信する  
- ログローテーションを設定する

### 取得する仕組み

#### プル型

- メリット
  - 監視サーバーがログを取得するため、ログの送信元に負荷がかからない
  - 取得対象からログが取得できない時点で、異常を検知できる
- 使い所
  - 固定化されたサービス
  - セキュリティの観点からログを送信することが難しい

#### プッシュ型

- メリット
  - リアルタイムでログを取得できる
  - エージェントをインストールするだけでログの送信が可能
- 使い所
  - スケーリングするサービス

## 参考

- [今さら聞けないログの基本と設計指針](https://qiita.com/tadashiro_ninomiya/items/19c774898c68add6185e)
- [構造化ログのフォーマット logfmt vs JSON lines](https://methane.hatenablog.jp/entry/2024/03/04/%E6%A7%8B%E9%80%A0%E5%8C%96%E3%83%AD%E3%82%B0%E3%81%AE%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88_logfmt_vs_JSON_lines)
- [CloudWatch Logs の機密データ保護機能で保護対象のカスタマイズができるようになりました](https://dev.classmethod.jp/articles/cloudwatch-logs-data-protection/)
- [モニタリングシステムの Push 型 Pull 型アプローチと Prometheus についての考察](https://yasuharu519.hatenablog.com/entry/2017/12/16/215855)
